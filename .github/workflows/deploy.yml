name: starlight BE ë°°í¬

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest # ì‘ì—…ì´ ì‹¤í–‰ë  í™˜ê²½
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: application-private.properties ë®ì–´ì“°ê¸°
        run: |
          echo ${{ secrets.PROPERTIES }}| base64 --decode > ./src/main/resources/application-private.properties
          cat ./src/main/resources/application-private.properties
          touch ./src/main/resources/application-private.properties
        shell: bash
      # - name: application-private.propertiesì— ì¶”ê°€ì„¤ì •
      #   run : |
      #     echo "" >> ./src/main/resources/application-private.properties
      #     echo -e "\nkakao.redirect.uri=http://${{ secrets.AWS_API }}:3000/api/auth/kakao/callback" >> ./src/main/resources/application-private.properties
      #     cat ./src/main/resources/application-private.properties
      - name: JDK 17 ì‚¬ìš©
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ì¶”ê°€
        run: chmod +x gradlew
      - name: Gradleë¡œ ë¹Œë“œ(CI)
        run: ./gradlew build

      - name: ë„ì»¤í—ˆë¸Œì— ë¡œê·¸ì¸
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USER_NAME }}
          password: ${{ secrets.DOCKER_USER_PW }}
      - name: ì´ë¯¸ì§€ ë¹Œë“œ
        run: sudo docker build -t ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }}-be .
      - name: ë„ì»¤í—ˆë¸Œì— ì´ë¯¸ì§€ í‘¸ì‹œ
        run: sudo docker push ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }}-be
      - name: AWS EC2ì— ssh ì ‘ì† í›„ ë°°í¬
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_IP }}
          port: 22
          username: ubuntu
          key: ${{ secrets.AWS_KEY }}
          script: |
            sudo docker stop backend || true
            sudo docker rm backend || true
            
            # ê¸°ì¡´ ë°±ì—”ë“œ ì´ë¯¸ì§€ ì‚­ì œ
            sudo docker rmi ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }}-be || true
            sudo docker pull ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }}-be
            
            # ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆë§Œ ì¬ì‹œì‘
            echo "ğŸ”„ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘"
            docker-compose up -d --force-recreate --build backend
            
            # ìƒíƒœ í™•ì¸ ë° ë¡œê·¸ ì¶œë ¥
            echo "âœ… ìƒíƒœ í™•ì¸"
            sudo docker ps -a
            sudo docker logs backend
